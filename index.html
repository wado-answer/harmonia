<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta name="description" content="Harmonia - 高機能モダン音楽プレイヤー">
    <meta name="theme-color" content="#6366f1">
    <title>Harmonia - 音楽プレイヤー</title>
    
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- フォント -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- スタイルシート -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- モバイルメニューボタン -->
    <button class="mobile-menu-btn" id="mobileMenuBtn" aria-label="メニューを開く">
        ☰
    </button>

    <!-- ✨ モバイルサイドバーオーバーレイ -->
    <div class="mobile-sidebar-overlay" id="sidebarOverlay" aria-hidden="true"></div>

    <div class="container">
        <!-- サイドバー -->
        <aside class="sidebar" id="sidebar">
            <header class="app-header">
                <h1 class="app-name">Harmonia</h1>
                <p class="app-tagline">音楽プレイヤー</p>
            </header>

            <!-- 検索バー -->
            <div class="search-bar">
                <input 
                    type="search" 
                    class="search-input" 
                    id="searchInput" 
                    placeholder="🔍 トラックを検索..."
                    aria-label="トラック検索">
            </div>

            <!-- ナビゲーション -->
            <nav class="sidebar-nav" role="navigation" aria-label="メインナビゲーション">
                <button class="sidebar-item active" data-view="library" aria-current="page">
                    <span class="sidebar-item-icon" aria-hidden="true">🎵</span>
                    ライブラリ
                </button>
                <button class="sidebar-item" data-view="favorites">
                    <span class="sidebar-item-icon" aria-hidden="true">❤️</span>
                    お気に入り
                </button>
                <button class="sidebar-item" data-view="playlists">
                    <span class="sidebar-item-icon" aria-hidden="true">📋</span>
                    プレイリスト
                </button>
                <button class="sidebar-item" data-view="queue">
                    <span class="sidebar-item-icon" aria-hidden="true">⏭</span>
                    キュー
                </button>
            </nav>

            <!-- クイックアクション -->
            <div class="quick-actions">
                <button class="quick-action-btn" id="uploadBtn">
                    <span class="sidebar-item-icon" aria-hidden="true">➕</span>
                    ファイルを追加
                </button>
                <button class="quick-action-btn" id="createPlaylistBtn">
                    <span class="sidebar-item-icon" aria-hidden="true">📝</span>
                    プレイリスト作成
                </button>
                <button class="quick-action-btn" id="settingsBtn">
                    <span class="sidebar-item-icon" aria-hidden="true">⚙️</span>
                    設定
                </button>
                <button class="quick-action-btn" id="aboutBtn">
                    <span class="sidebar-item-icon" aria-hidden="true">ℹ️</span>
                    アプリについて
                </button>
            </div>
        </aside>

        <!-- メインコンテンツ -->
        <main class="main-content">
            <!-- ライブラリビュー -->
            <section id="libraryView" class="view active">
                <header class="view-header">
                    <h2 class="view-title">ライブラリ</h2>
                    <p class="view-subtitle">すべてのトラック</p>
                </header>

                <!-- ビジュアライザー -->
                <div class="visualizer-container">
                    <canvas id="visualizerCanvas" aria-label="オーディオビジュアライザー"></canvas>
                </div>

                <div class="track-list" id="trackList" role="list">
                    <!-- トラックは動的に生成されます -->
                </div>
            </section>

            <!-- お気に入りビュー -->
            <section id="favoritesView" class="view">
                <header class="view-header">
                    <h2 class="view-title">お気に入り</h2>
                    <p class="view-subtitle">お気に入りのトラック</p>
                </header>

                <div class="track-list" id="favoritesList" role="list">
                    <!-- お気に入りトラックは動的に生成されます -->
                </div>
            </section>

            <!-- プレイリストビュー -->
            <section id="playlistsView" class="view">
                <header class="view-header">
                    <h2 class="view-title">プレイリスト</h2>
                    <p class="view-subtitle">あなたのプレイリスト</p>
                </header>

                <div id="playlistsContainer">
                    <!-- プレイリストは動的に生成されます -->
                </div>
            </section>

            <!-- キュービュー -->
            <section id="queueView" class="view">
                <header class="view-header">
                    <h2 class="view-title">キュー</h2>
                    <p class="view-subtitle">次に再生される曲</p>
                </header>

                <div style="margin-bottom: 16px;">
                    <button class="btn btn-secondary" id="clearQueueBtn">
                        キューをクリア
                    </button>
                </div>

                <div id="queueList" role="list">
                    <!-- キューは動的に生成されます -->
                </div>
            </section>
        </main>
    </div>

    <!-- プレイヤー -->
    <footer class="player" role="region" aria-label="音楽プレイヤー">
        <div class="progress-container" id="progressContainer">
            <span class="progress-time" id="currentTime" aria-live="off">0:00</span>
            <div class="progress-track" role="slider" aria-label="再生位置" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" tabindex="0">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <span class="progress-time" id="duration" aria-live="off">0:00</span>
        </div>

        <div class="player-main">
            <div class="now-playing">
                <div class="now-playing-artwork" id="nowPlayingArtwork" aria-label="現在の曲のアートワーク">
                    🎵
                </div>
                <div class="now-playing-info">
                    <div class="now-playing-title" id="nowPlayingTitle">トラックが選択されていません</div>
                    <div class="now-playing-artist" id="nowPlayingArtist">アーティスト</div>
                </div>
            </div>

            <div class="player-controls">
                <button class="control-btn" id="prevBtn" aria-label="前のトラック">
                    ⏮
                </button>
                <button class="control-btn play" id="playBtn" aria-label="再生">
                    ▶
                </button>
                <button class="control-btn" id="nextBtn" aria-label="次のトラック">
                    ⏭
                </button>
            </div>

            <div class="player-extras">
                <button class="icon-btn" id="abRepeatBtn" aria-label="A-Bリピート" aria-pressed="false" title="A-Bリピート: A点→B点→A点設定">
                    🔄
                </button>
                <button class="icon-btn" id="shuffleBtn" aria-label="シャッフル" aria-pressed="false">
                    🔀
                </button>
                <button class="icon-btn" id="shareTrackBtn" aria-label="共有" title="再生中トラックを共有">
                    📤
                </button>
                <button class="icon-btn" id="repeatBtn" aria-label="リピート" aria-pressed="false">
                    🔁
                </button>
                <div class="volume-container">
                    <button class="icon-btn" id="volumeIcon" aria-label="音量">🔊</button>
                    <div class="volume-slider" role="slider" aria-label="音量" aria-valuemin="0" aria-valuemax="100" aria-valuenow="70" tabindex="0">
                        <div class="volume-fill" id="volumeFill" style="width: 70%;"></div>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- オーディオ要素 -->
    <audio id="audioElement" preload="metadata"></audio>

    <!-- ファイルアップロードモーダル -->
    <div id="uploadModal" class="modal" role="dialog" aria-labelledby="uploadModalTitle" aria-modal="true" aria-hidden="true">
        <div class="modal-content">
            <header class="modal-header">
                <h3 class="modal-title" id="uploadModalTitle">ファイルを追加</h3>
                <button class="close-btn" id="closeUploadModal" aria-label="閉じる">✕</button>
            </header>
            <div class="form-group">
                <label class="form-label" for="fileInput">音楽ファイルを選択</label>
                <input type="file" id="fileInput" class="form-input" accept="audio/*" multiple>
            </div>
            <p style="font-size: 13px; color: var(--theme-text-secondary);">
                対応フォーマット: MP3, WAV, OGG, M4A, FLAC<br>
                🆕 ID3タグとアートワークを自動読み取り
            </p>
        </div>
    </div>

    <!-- 設定モーダル（タブベース） -->
    <div id="settingsModal" class="modal" role="dialog" aria-labelledby="settingsModalTitle" aria-modal="true" aria-hidden="true">
        <div class="modal-content" style="max-width: 700px; max-height: 85vh; display: flex; flex-direction: column;">
            <header class="modal-header">
                <h3 class="modal-title" id="settingsModalTitle">設定</h3>
                <button class="close-btn" id="closeSettingsModal" aria-label="閉じる">✕</button>
            </header>

            <!-- ✨ タブナビゲーション -->
            <div class="settings-tabs" role="tablist" aria-label="設定タブ">
                <button class="settings-tab active" role="tab" data-tab="appearance" aria-selected="true">🎨 表示</button>
                <button class="settings-tab" role="tab" data-tab="equalizer" aria-selected="false">🎛️ イコライザー</button>
                <button class="settings-tab" role="tab" data-tab="playback" aria-selected="false">▶️ 再生</button>
                <button class="settings-tab" role="tab" data-tab="keyboard" aria-selected="false">⌨️ ショートカット</button>
                <button class="settings-tab" role="tab" data-tab="data" aria-selected="false">💾 データ</button>
            </div>

            <!-- タブコンテンツ容器 -->
            <div class="settings-content" style="flex: 1; overflow-y: auto; padding: 20px;">

                <!-- 📱 表示タブ -->
                <div class="settings-panel active" id="appearance-panel" role="tabpanel" aria-labelledby="appearance-tab">
                    <div class="form-group">
                        <label class="form-label">🎨 テーマ</label>
                        <div class="theme-selector" role="radiogroup" aria-label="テーマ選択">
                            <button class="theme-option active" data-theme="default" role="radio" aria-checked="true">
                                <div class="theme-preview" style="background: linear-gradient(135deg, #6366f1, #ec4899);"></div>
                                <div style="font-size: 12px;">デフォルト</div>
                            </button>
                            <button class="theme-option" data-theme="ocean" role="radio" aria-checked="false">
                                <div class="theme-preview" style="background: linear-gradient(135deg, #06b6d4, #22d3ee);"></div>
                                <div style="font-size: 12px;">オーシャン</div>
                            </button>
                            <button class="theme-option" data-theme="sunset" role="radio" aria-checked="false">
                                <div class="theme-preview" style="background: linear-gradient(135deg, #f59e0b, #dc2626);"></div>
                                <div style="font-size: 12px;">サンセット</div>
                            </button>
                            <button class="theme-option" data-theme="forest" role="radio" aria-checked="false">
                                <div class="theme-preview" style="background: linear-gradient(135deg, #10b981, #34d399);"></div>
                                <div style="font-size: 12px;">フォレスト</div>
                            </button>
                            <button class="theme-option" data-theme="minimal" role="radio" aria-checked="false">
                                <div class="theme-preview" style="background: linear-gradient(135deg, #64748b, #94a3b8);"></div>
                                <div style="font-size: 12px;">ミニマル</div>
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="visualizerToggle" checked>
                            ビジュアライザーを表示
                        </label>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ビジュアライザースタイル</label>
                        <select id="visualizerStyle" style="width: 100%; padding: 8px; border: 1px solid var(--theme-border); border-radius: 6px; background: var(--theme-bg-secondary); color: var(--theme-text-primary); font-size: 14px;">
                            <option value="bars">標準バー</option>
                            <option value="circular">円形</option>
                            <option value="waveform">波形</option>
                            <option value="spectrum">スペクトラム</option>
                            <option value="particles">パーティクル</option>
                            <option value="radial">放射状</option>
                            <option value="mirror">ミラー</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">表示密度</label>
                        <select id="compactDensity" style="width: 100%; padding: 8px; border: 1px solid var(--theme-border); border-radius: 6px; background: var(--theme-bg-secondary); color: var(--theme-text-primary); font-size: 14px;">
                            <option value="comfortable">ゆったり (default)</option>
                            <option value="compact">コンパクト</option>
                            <option value="condensed">密集</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ミニプレイヤー位置</label>
                        <select id="miniPlayerPosition" style="width: 100%; padding: 8px; border: 1px solid var(--theme-border); border-radius: 6px; background: var(--theme-bg-secondary); color: var(--theme-text-primary); font-size: 14px;">
                            <option value="bottom">下部 (default)</option>
                            <option value="left">左</option>
                            <option value="right">右</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">アクセントカラー</label>
                        <div style="display:flex; gap:8px;">
                            <button class="theme-accent" data-accent="default" style="width:34px; height:34px; border-radius:6px; background: linear-gradient(135deg,#6366f1,#ec4899); border: 1px solid var(--theme-border);"></button>
                            <button class="theme-accent" data-accent="#06b6d4" style="width:34px; height:34px; border-radius:6px; background:#06b6d4; border: 1px solid var(--theme-border);"></button>
                            <button class="theme-accent" data-accent="#f59e0b" style="width:34px; height:34px; border-radius:6px; background:#f59e0b; border: 1px solid var(--theme-border);"></button>
                            <button class="theme-accent" data-accent="#10b981" style="width:34px; height:34px; border-radius:6px; background:#10b981; border: 1px solid var(--theme-border);"></button>
                            <input type="color" id="customAccentPicker" value="#6366f1" style="width:46px; height:34px; border-radius:6px; border: 1px solid var(--theme-border);">
                        </div>
                    </div>
                </div>

                <!-- 🎛️ イコライザータブ -->
                <div class="settings-panel" id="equalizer-panel" role="tabpanel" aria-labelledby="equalizer-tab">
                    <div class="form-group">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <label class="form-label">10バンドイコライザー</label>
                            <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" id="resetEqBtn">
                                リセット
                            </button>
                        </div>

                        <!-- ✨ EQプリセット -->
                        <div style="margin-bottom: 12px;">
                            <label class="form-label">プリセット</label>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px;">
                                <button class="btn btn-secondary eq-preset" data-preset="flat" style="font-size: 12px;">フラット</button>
                                <button class="btn btn-secondary eq-preset" data-preset="pop" style="font-size: 12px;">ポップ</button>
                                <button class="btn btn-secondary eq-preset" data-preset="rock" style="font-size: 12px;">ロック</button>
                                <button class="btn btn-secondary eq-preset" data-preset="jazz" style="font-size: 12px;">ジャズ</button>
                                <button class="btn btn-secondary eq-preset" data-preset="classical" style="font-size: 12px;">クラシック</button>
                                <button class="btn btn-secondary eq-preset" data-preset="edm" style="font-size: 12px;">EDM</button>
                            </div>
                        </div>

                        <div class="form-group" style="margin-top:8px;">
                            <label class="form-label">
                                <input type="checkbox" id="eqEnabledToggle">
                                イコライザーを有効化
                            </label>
                        </div>

                        <!-- 10バンドスライダー -->
                        <div class="equalizer-10band">
                            <div class="eq-band" style="flex: 1;">
                                <label class="eq-label">32Hz</label>
                                <input type="range" class="eq-slider" data-band="0" min="-12" max="12" step="1" value="0">
                                <div class="eq-value">0dB</div>
                            </div>
                            <div class="eq-band" style="flex: 1;">
                                <label class="eq-label">64Hz</label>
                                <input type="range" class="eq-slider" data-band="1" min="-12" max="12" step="1" value="0">
                                <div class="eq-value">0dB</div>
                            </div>
                            <div class="eq-band" style="flex: 1;">
                                <label class="eq-label">125Hz</label>
                                <input type="range" class="eq-slider" data-band="2" min="-12" max="12" step="1" value="0">
                                <div class="eq-value">0dB</div>
                            </div>
                            <div class="eq-band" style="flex: 1;">
                                <label class="eq-label">250Hz</label>
                                <input type="range" class="eq-slider" data-band="3" min="-12" max="12" step="1" value="0">
                                <div class="eq-value">0dB</div>
                            </div>
                            <div class="eq-band" style="flex: 1;">
                                <label class="eq-label">500Hz</label>
                                <input type="range" class="eq-slider" data-band="4" min="-12" max="12" step="1" value="0">
                                <div class="eq-value">0dB</div>
                            </div>
                            <div class="eq-band" style="flex: 1;">
                                <label class="eq-label">1kHz</label>
                                <input type="range" class="eq-slider" data-band="5" min="-12" max="12" step="1" value="0">
                                <div class="eq-value">0dB</div>
                            </div>
                            <div class="eq-band" style="flex: 1;">
                                <label class="eq-label">2kHz</label>
                                <input type="range" class="eq-slider" data-band="6" min="-12" max="12" step="1" value="0">
                                <div class="eq-value">0dB</div>
                            </div>
                            <div class="eq-band" style="flex: 1;">
                                <label class="eq-label">4kHz</label>
                                <input type="range" class="eq-slider" data-band="7" min="-12" max="12" step="1" value="0">
                                <div class="eq-value">0dB</div>
                            </div>
                            <div class="eq-band" style="flex: 1;">
                                <label class="eq-label">8kHz</label>
                                <input type="range" class="eq-slider" data-band="8" min="-12" max="12" step="1" value="0">
                                <div class="eq-value">0dB</div>
                            </div>
                            <div class="eq-band" style="flex: 1;">
                                <label class="eq-label">16kHz</label>
                                <input type="range" class="eq-slider" data-band="9" min="-12" max="12" step="1" value="0">
                                <div class="eq-value">0dB</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ▶️ 再生タブ -->
                <div class="settings-panel" id="playback-panel" role="tabpanel" aria-labelledby="playback-tab">
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="backgroundPlayToggle" checked>
                            バックグラウンド再生を有効化
                        </label>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="crossfadeToggle">
                            クロスフェード再生を有効化
                        </label>
                        <small style="color: var(--theme-text-secondary); font-size: 12px;">
                            曲と曲の間をスムーズに繋ぎます（3秒）
                        </small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="gaplessToggle" checked>
                            ギャップレス再生を有効化
                        </label>
                        <small style="color: var(--theme-text-secondary); font-size: 12px;">
                            次の曲を事前読み込みして途切れを防ぎます
                        </small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="powerSaveToggle">
                            🔋 省エネモードを有効化
                        </label>
                        <small style="color: var(--theme-text-secondary); font-size: 12px;">
                            CPU使用率を削減してバッテリーを節約します
                        </small>
                    </div>

                    <div class="form-group" id="powerSaveProfileGroup" style="display: none;">
                        <label class="form-label">省エネプロファイル</label>
                        <div style="display: flex; gap: 8px; margin-top: 8px;">
                            <label style="flex: 1; cursor: pointer;">
                                <input type="radio" name="powerSaveProfile" value="aggressive"> ⚡ 最大節約
                            </label>
                            <label style="flex: 1; cursor: pointer;">
                                <input type="radio" name="powerSaveProfile" value="balanced" checked> ⚖️ バランス
                            </label>
                            <label style="flex: 1; cursor: pointer;">
                                <input type="radio" name="powerSaveProfile" value="none"> 🚀 フル機能
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">再生速度</label>
                        <div style="display: flex; gap: 8px; margin-top: 8px;">
                            <input type="range" id="playbackRateSlider" min="0.5" max="2.0" step="0.05" value="1.0" 
                                   style="flex: 1;" aria-label="再生速度">
                            <span id="playbackRateValue" style="min-width: 50px; text-align: right;">1.00x</span>
                        </div>
                        <div style="display: flex; gap: 8px; margin-top: 8px;">
                            <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px; flex: 1;">0.75x</button>
                            <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px; flex: 1;">1.0x</button>
                            <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px; flex: 1;">1.25x</button>
                            <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px; flex: 1;">1.5x</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">クロスフェード時間</label>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <input type="range" id="crossfadeDuration" min="0" max="10" step="1" value="3" style="flex:1;">
                            <span id="crossfadeDurationValue" style="min-width:40px; text-align:right;">3s</span>
                        </div>
                        <small style="color: var(--theme-text-secondary); font-size: 12px;">曲間のフェード時間を秒で指定します</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="loudnessNormalizationToggle">
                            ラウドネス正規化を有効化（再生音量の自動調整）
                        </label>
                    </div>

                    <div class="form-group">
                        <label class="form-label">最大音量制限</label>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <input type="range" id="maxVolumeLimit" min="0.2" max="1.0" step="0.01" value="1.0" style="flex:1;">
                            <span id="maxVolumeLimitValue" style="min-width:40px; text-align:right;">100%</span>
                        </div>
                        <small style="color: var(--theme-text-secondary); font-size: 12px;">スピーカー保護や大音量対策に使用します</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">スリープタイマー</label>
                        <div style="display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap;">
                            <button class="btn btn-secondary" style="padding: 8px 12px; font-size: 12px;" id="sleep15">15分</button>
                            <button class="btn btn-secondary" style="padding: 8px 12px; font-size: 12px;" id="sleep30">30分</button>
                            <button class="btn btn-secondary" style="padding: 8px 12px; font-size: 12px;" id="sleep45">45分</button>
                            <button class="btn btn-secondary" style="padding: 8px 12px; font-size: 12px;" id="sleep60">60分</button>
                            <button class="btn btn-secondary" style="padding: 8px 12px; font-size: 12px;" id="sleepCancel">キャンセル</button>
                        </div>
                        <div id="sleepTimerStatus" style="margin-top: 8px; font-size: 12px; color: var(--theme-text-secondary);"></div>
                    </div>
                </div>

                <!-- ⌨️ キーボードショートカットタブ -->
                <div class="settings-panel" id="keyboard-panel" role="tabpanel" aria-labelledby="keyboard-tab">
                    <div style="margin-bottom: 16px;">
                        <h4 style="margin-bottom: 12px;">再生制御</h4>
                        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                            <tr style="border-bottom: 1px solid var(--theme-border);">
                                <td style="padding: 8px;">Space</td>
                                <td style="text-align: right; color: var(--theme-text-secondary);">再生／一時停止</td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--theme-border);">
                                <td style="padding: 8px;">←  →</td>
                                <td style="text-align: right; color: var(--theme-text-secondary);">前後にシーク</td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--theme-border);">
                                <td style="padding: 8px;">↑  ↓</td>
                                <td style="text-align: right; color: var(--theme-text-secondary);">音量調整</td>
                            </tr>
                        </table>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <h4 style="margin-bottom: 12px;">UI制御</h4>
                        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                            <tr style="border-bottom: 1px solid var(--theme-border);">
                                <td style="padding: 8px;">Esc</td>
                                <td style="text-align: right; color: var(--theme-text-secondary);">モーダル／メニューを閉じる</td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--theme-border);">
                                <td style="padding: 8px;">Ctrl + S</td>
                                <td style="text-align: right; color: var(--theme-text-secondary);">設定を保存</td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--theme-border);">
                                <td style="padding: 8px;">Ctrl + A</td>
                                <td style="text-align: right; color: var(--theme-text-secondary);">すべてを選択</td>
                            </tr>
                        </table>
                    </div>
                </div>

                <!-- 💾 データタブ -->
                <div class="settings-panel" id="data-panel" role="tabpanel" aria-labelledby="data-tab">
                    <div class="form-group">
                        <h4 style="margin-bottom: 12px;">バックアップ &amp; リストア</h4>
                        <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                            <button class="btn btn-secondary" style="flex: 1; padding: 10px;" id="backupBtn">
                                💾 バックアップ作成
                            </button>
                            <button class="btn btn-secondary" style="flex: 1; padding: 10px;" id="restoreBtn">
                                📂 バックアップから復元
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <h4 style="margin-bottom: 12px;">データ管理</h4>
                        <button class="btn btn-secondary" style="width: 100%; padding: 10px; margin-bottom: 8px;" id="exportSettingsBtn">
                            📊 設定をエクスポート
                        </button>
                        <button class="btn btn-secondary" style="width: 100%; padding: 10px; margin-bottom: 8px;" id="clearHistoryBtn">
                            🗑️ 再生履歴をクリア
                        </button>
                        <button class="btn btn-secondary" style="width: 100%; padding: 10px; margin-bottom: 8px;" id="resetSettingsBtn">
                            🔄 設定をリセット
                        </button>
                        <button class="btn btn-secondary" style="width: 100%; padding: 10px; background: #ef4444; color: white;" id="deleteAllBtn">
                            🔴 すべてのデータを削除
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- アバウトモーダル -->
    <div id="aboutModal" class="modal" role="dialog" aria-labelledby="aboutModalTitle" aria-modal="true" aria-hidden="true">
        <div class="modal-content">
            <header class="modal-header">
                <h3 class="modal-title" id="aboutModalTitle">Harmoniaについて</h3>
                <button class="close-btn" id="closeAboutModal" aria-label="閉じる">✕</button>
            </header>

            <div style="text-align: center; margin-bottom: 24px;">
                <div style="font-size: 64px; margin-bottom: 16px;" aria-hidden="true">🎵</div>
                <h4 style="font-size: 20px; margin-bottom: 8px;">Harmonia</h4>
                <p style="color: var(--theme-text-secondary); font-size: 14px;">Version 3.0.0</p>
            </div>

            <div style="margin-bottom: 20px;">
                <h5 style="margin-bottom: 12px; font-size: 16px;">🆕 主な機能</h5>
                <ul style="font-size: 14px; color: var(--theme-text-secondary); line-height: 1.8; padding-left: 20px;">
                    <li>キュー機能（次に再生リスト）</li>
                    <li>トラック検索</li>
                    <li>3バンドイコライザー</li>
                    <li>音連動ビジュアライザー</li>
                    <li>クロスフェード再生</li>
                    <li>トラック永続保存</li>
                    <li>ID3タグ＆アートワーク表示</li>
                    <li>ギャップレス再生</li>
                    <li>PWA対応（オフライン動作）</li>
                </ul>
            </div>

            <div style="text-align: center; font-size: 12px; color: var(--theme-text-secondary);">
                © 2024 Harmonia. All rights reserved.
            </div>
        </div>
    </div>

    <!-- プレイリスト管理モーダル（新規作成・編集） -->
    <div id="playlistManagementModal" class="modal" role="dialog" aria-labelledby="playlistManagementTitle" aria-modal="true" aria-hidden="true">
        <div class="modal-content" style="max-width: 500px;">
            <header class="modal-header">
                <h3 class="modal-title" id="playlistManagementTitle">プレイリストを作成</h3>
                <button class="close-btn" id="closePlaylistModal" aria-label="閉じる">✕</button>
            </header>

            <div style="padding: 20px;">
                <div style="margin-bottom: 16px;">
                    <label for="playlistNameInput" style="display: block; margin-bottom: 8px; font-weight: 600;">プレイリスト名 *</label>
                    <input type="text" id="playlistNameInput" placeholder="例：クラシック音楽" style="width: 100%; padding: 10px; border: 1px solid var(--theme-border); border-radius: 6px; font-size: 14px;">
                </div>

                <div style="margin-bottom: 16px;">
                    <label for="playlistDescInput" style="display: block; margin-bottom: 8px; font-weight: 600;">説明（オプション）</label>
                    <textarea id="playlistDescInput" placeholder="プレイリストの説明を入力..." style="width: 100%; padding: 10px; border: 1px solid var(--theme-border); border-radius: 6px; font-size: 14px; min-height: 80px; resize: vertical;"></textarea>
                </div>

                <div style="margin-bottom: 20px;">
                    <label for="playlistColorInput" style="display: block; margin-bottom: 8px; font-weight: 600;">プレイリスト色（オプション）</label>
                    <input type="color" id="playlistColorInput" value="#6366f1" style="width: 60px; height: 40px; border: 1px solid var(--theme-border); border-radius: 6px; cursor: pointer;">
                </div>

                <div style="display: flex; gap: 12px; margin-top: 24px;">
                    <button id="cancelPlaylistBtn" style="flex: 1; padding: 10px; border: 1px solid var(--theme-border); background: transparent; color: var(--theme-text); border-radius: 6px; cursor: pointer; font-size: 14px;">キャンセル</button>
                    <button id="createPlaylistSubmitBtn" style="flex: 1; padding: 10px; background: var(--theme-primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">作成</button>
                </div>
            </div>
        </div>
    </div>

    <!-- プレイリスト管理メニューモーダル -->
    <div id="playlistActionsModal" class="modal" role="dialog" aria-labelledby="playlistActionsTitle" aria-modal="true" aria-hidden="true">
        <div class="modal-content" style="max-width: 350px;">
            <header class="modal-header">
                <h3 class="modal-title" id="playlistActionsTitle" style="font-size: 16px;">プレイリスト操作</h3>
                <button class="close-btn" id="closePlaylistActionsModal" aria-label="閉じる">✕</button>
            </header>

            <div style="padding: 12px 0;">
                <button class="playlist-action-btn" id="editPlaylistBtn" style="width: 100%; padding: 12px 16px; border: none; background: transparent; text-align: left; cursor: pointer; border-bottom: 1px solid var(--theme-border); font-size: 14px;">✎ 編集</button>
                <button class="playlist-action-btn" id="duplicatePlaylistBtn" style="width: 100%; padding: 12px 16px; border: none; background: transparent; text-align: left; cursor: pointer; border-bottom: 1px solid var(--theme-border); font-size: 14px;">📋 複製</button>
                <button class="playlist-action-btn" id="exportPlaylistBtn" style="width: 100%; padding: 12px 16px; border: none; background: transparent; text-align: left; cursor: pointer; border-bottom: 1px solid var(--theme-border); font-size: 14px;">⬇ エクスポート</button>
                <button class="playlist-action-btn" id="sharePlaylistBtn" style="width: 100%; padding: 12px 16px; border: none; background: transparent; text-align: left; cursor: pointer; border-bottom: 1px solid var(--theme-border); font-size: 14px;">📤 共有</button>
                <button class="playlist-action-btn" id="deletePlaylistBtn" style="width: 100%; padding: 12px 16px; border: none; background: transparent; text-align: left; cursor: pointer; color: #ef4444; font-size: 14px;">🗑 削除</button>
            </div>
        </div>
    </div>

    <!-- メインアプリケーション（モジュール） -->
    <script type="module" src="app.js"></script>
    
    <!-- UI イベントハンドラー -->
    <script>
        // 🔧 モバイルメニュー＆オーバーレイ管理
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');

        function closeMobileMenu() {
            sidebar.classList.remove('mobile-open');
            overlay.classList.remove('active');
        }

        function openMobileMenu() {
            sidebar.classList.add('mobile-open');
            overlay.classList.add('active');
        }

        const addAppListener = (el, ev, handler, opts) => {
            if (window.harmonia && typeof window.harmonia.addTrackedListener === 'function') {
                window.harmonia.addTrackedListener(el, ev, handler, opts);
            } else {
                el.addEventListener(ev, handler, opts);
            }
        };

        addAppListener(mobileMenuBtn, 'click', () => {
            if (sidebar.classList.contains('mobile-open')) {
                closeMobileMenu();
            } else {
                openMobileMenu();
            }
        });

        // ✨ オーバーレイクリックでメニュー閉じる
        addAppListener(overlay, 'click', closeMobileMenu);

        // ビュー切り替え
        document.querySelectorAll('.sidebar-item').forEach(item => {
            addAppListener(item, 'click', () => {
                const viewName = item.dataset.view;
                window.harmonia.ui.switchView(viewName);
                
                // モバイルでサイドバーを閉じる
                if (window.innerWidth <= 768) {
                    closeMobileMenu();
                }
            });
        });

        // ⌘ Escキーでサイドバーを閉じる
        addAppListener(document, 'keydown', (e) => {
            if (e.key === 'Escape' && sidebar.classList.contains('mobile-open')) {
                closeMobileMenu();
            }
        });

        // モーダル操作
        addAppListener(document.getElementById('uploadBtn'), 'click', () => {
            window.harmonia.ui.openModal('uploadModal');
        });
        addAppListener(document.getElementById('createPlaylistBtn'), 'click', () => {
            window.harmonia.ui.openModal('playlistManagementModal');
        });
        addAppListener(document.getElementById('settingsBtn'), 'click', () => {
            window.harmonia.ui.openModal('settingsModal');
        });
        addAppListener(document.getElementById('aboutBtn'), 'click', () => {
            window.harmonia.ui.openModal('aboutModal');
        });

        addAppListener(document.getElementById('closeUploadModal'), 'click', () => {
            window.harmonia.ui.closeModal('uploadModal');
        });
        addAppListener(document.getElementById('closeSettingsModal'), 'click', () => {
            window.harmonia.ui.closeModal('settingsModal');
        });
        addAppListener(document.getElementById('closeAboutModal'), 'click', () => {
            window.harmonia.ui.closeModal('aboutModal');
        });

        // プレイリスト管理モーダル
        addAppListener(document.getElementById('closePlaylistModal'), 'click', () => {
            window.harmonia.ui.closeModal('playlistManagementModal');
        });

        // プレイリスト作成フォーム送信
        const createPlaylistSubmitBtn = document.getElementById('createPlaylistSubmitBtn');
        if (createPlaylistSubmitBtn) {
            addAppListener(createPlaylistSubmitBtn, 'click', async () => {
                const name = document.getElementById('playlistNameInput').value.trim();
                const desc = document.getElementById('playlistDescInput').value.trim();
                const color = document.getElementById('playlistColorInput').value || '#6366f1';

                if (!name) {
                    window.harmonia.ui.showNotification('プレイリスト名を入力してください', 'error');
                    return;
                }

                try {
                    if (window.harmonia && typeof window.harmonia.createPlaylist === 'function') {
                        await window.harmonia.createPlaylist(name, desc, { color });
                    } else if (window.harmonia && window.harmonia.playlistManager) {
                        await window.harmonia.playlistManager.createPlaylist(name, desc, { color });
                    }

                    window.harmonia.ui.showNotification('✅ プレイリストを作成しました', 'success');
                    window.harmonia.ui.closeModal('playlistManagementModal');
                    window.harmonia.renderPlaylists?.();
                } catch (err) {
                    console.error('Failed to create playlist', err);
                    window.harmonia.ui.showNotification('プレイリスト作成に失敗しました', 'error');
                }
            });
        }

        // ✨ ビジュアライザースタイル変更
        addAppListener(document.getElementById('visualizerStyle'), 'change', (e) => {
            const style = e.target.value;
            document.dispatchEvent(new CustomEvent('harmonia:setVisualizerStyle', {
                detail: style
            }));
            window.harmonia?.ui.showNotification(`✅ ビジュアライザーを「${e.target.options[e.target.selectedIndex].text}」に変更しました`, 'success');
        });

        // ミニプレイヤー位置変更
        const miniPosSelect = document.getElementById('miniPlayerPosition');
        if (miniPosSelect) {
            addAppListener(miniPosSelect, 'change', (e) => {
                const value = e.target.value;
                document.dispatchEvent(new CustomEvent('harmonia:updateSetting', {
                    detail: { key: 'miniPlayerPosition', value }
                }));
                // 即時反映（冗長だが UI 応答性向上）
                try { document.body.setAttribute('data-mini-position', value); } catch (err) {}
                if (window.harmonia && window.harmonia.ui) window.harmonia.ui.showNotification(`✅ ミニプレイヤー位置を「${value}」に変更しました`, 'success');
            });

            // 初期値を保存された設定から反映（window.harmonia の初期化を待つ）
            (function waitForHarmoniaInit() {
                const apply = () => {
                    try {
                        const settings = window.harmonia?.state?.get('settings');
                        if (settings && settings.miniPlayerPosition) {
                            miniPosSelect.value = settings.miniPlayerPosition;
                            document.body.setAttribute('data-mini-position', settings.miniPlayerPosition);
                        }
                    } catch (e) {}
                };

                if (window.harmonia && window.harmonia.state) {
                    apply();
                } else {
                    let waited = 0;
                    const iv = setInterval(() => {
                        if (window.harmonia && window.harmonia.state) {
                            apply();
                            clearInterval(iv);
                        }
                        waited += 200;
                        if (waited > 10000) clearInterval(iv);
                    }, 200);
                }
            })();
        }

        // ✨ 設定パネルのタブ機能
        document.querySelectorAll('.settings-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                
                // タブボタンのアクティブ状態を更新
                document.querySelectorAll('.settings-tab').forEach(t => {
                    t.classList.remove('active');
                });
                tab.classList.add('active');
                
                // パネルの表示を更新
                document.querySelectorAll('.settings-panel').forEach(panel => {
                    panel.classList.remove('active');
                });
                document.getElementById(tabName + '-panel').classList.add('active');
            });
        });

        // ✨ 10バンドEQスライダー処理
        document.querySelectorAll('.equalizer-10band .eq-slider').forEach((slider, index) => {
            slider.addEventListener('input', (e) => {
                const band = parseInt(e.target.dataset.band);
                const value = parseInt(e.target.value);
                
                // 値表示を更新
                e.target.parentElement.querySelector('.eq-value').textContent = value + 'dB';
                
                // イベントを発射してapp.jsで処理
                document.dispatchEvent(new CustomEvent('harmonia:setEQBand', {
                    detail: { band, gain: value }
                }));
            });
        });

        // ✨ EQプリセット機能
        const eqPresets = {
            'flat': [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            'pop': [1, 2, -2, -3, -1, -1, 0, 2, 4, 4],
            'rock': [5, 3, -2, -3, -1, 1, 3, 5, 7, 8],
            'jazz': [3, 2, 1, 2, 0, -1, -2, 1, 3, 5],
            'classical': [4, 3, 0, -2, -2, -1, -1, 0, 4, 6],
            'edm': [6, 5, -1, -2, -1, 0, -1, 3, 6, 8]
        };

        document.querySelectorAll('.eq-preset').forEach(btn => {
            btn.addEventListener('click', () => {
                const preset = btn.dataset.preset;
                const gains = eqPresets[preset];
                
                if (gains) {
                    // すべてのスライダーを設定
                    document.querySelectorAll('.equalizer-10band .eq-slider').forEach((slider, index) => {
                        slider.value = gains[index];
                        slider.parentElement.querySelector('.eq-value').textContent = gains[index] + 'dB';
                        
                        // イベントを発射
                        document.dispatchEvent(new CustomEvent('harmonia:setEQBand', {
                            detail: { band: index, gain: gains[index] }
                        }));
                    });
                    
                    // プリセットボタンのアクティブ状態
                    document.querySelectorAll('.eq-preset').forEach(b => {
                        b.classList.remove('active');
                    });
                    btn.classList.add('active');
                    
                    window.harmonia?.ui.showNotification(`✅ ${btn.textContent} プリセットを適用しました`, 'success');
                }
            });
        });

        // EQリセット
        document.getElementById('resetEqBtn').addEventListener('click', () => {
            document.querySelectorAll('.equalizer-10band .eq-slider').forEach((slider, index) => {
                slider.value = 0;
                slider.parentElement.querySelector('.eq-value').textContent = '0dB';
                
                document.dispatchEvent(new CustomEvent('harmonia:setEQBand', {
                    detail: { band: index, gain: 0 }
                }));
            });
            
            // プリセットボタンをリセット
            document.querySelectorAll('.eq-preset').forEach(b => {
                b.classList.remove('active');
            });
            document.querySelector('[data-preset="flat"]').classList.add('active');
            
            window.harmonia?.ui.showNotification('✅ イコライザーをリセットしました', 'success');
        });

        // 初期化: 保存済み設定をUIに反映
        (function applySavedSettingsToUI() {
            try {
                const settings = window.harmonia?.state?.get('settings') || {};

                // テーマ
                if (settings.theme) {
                    document.body.setAttribute('data-theme', settings.theme);
                    document.querySelectorAll('.theme-option').forEach(opt => {
                        opt.classList.remove('active');
                        opt.setAttribute('aria-checked', 'false');
                        if (opt.dataset.theme === settings.theme) {
                            opt.classList.add('active');
                            opt.setAttribute('aria-checked', 'true');
                        }
                    });
                }

                // ビジュアライザー
                const visualizerToggle = document.getElementById('visualizerToggle');
                if (visualizerToggle && typeof settings.visualizerEnabled === 'boolean') {
                    visualizerToggle.checked = settings.visualizerEnabled;
                }

                // EQスライダー
                if (Array.isArray(settings.eq10Band)) {
                    document.querySelectorAll('.equalizer-10band .eq-slider').forEach((slider, idx) => {
                        const v = settings.eq10Band[idx] ?? 0;
                        slider.value = v;
                        const valueEl = slider.parentElement.querySelector('.eq-value');
                        if (valueEl) valueEl.textContent = v + 'dB';
                    });
                }

                // EQプリセット状態
                document.querySelectorAll('.eq-preset').forEach(b => b.classList.remove('active'));
                if (settings.eqPreset) {
                    const presetBtn = document.querySelector(`.eq-preset[data-preset="${settings.eqPreset}"]`);
                    if (presetBtn) presetBtn.classList.add('active');
                }
            } catch (err) {
                console.warn('Failed to apply saved settings to UI:', err);
            }
        })();

        // ✨ データ管理ボタン
        document.getElementById('backupBtn').addEventListener('click', () => {
            window.harmonia?.ui.showNotification('💾 バックアップを作成しています...', 'info');
            // バックアップ処理はapp.jsで実装
            document.dispatchEvent(new CustomEvent('harmonia:exportFullBackup'));
        });

        document.getElementById('restoreBtn').addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const data = JSON.parse(event.target.result);
                            document.dispatchEvent(new CustomEvent('harmonia:importBackup', {
                                detail: data
                            }));
                        } catch (error) {
                            window.harmonia?.ui.showNotification('❌ バックアップファイルが無効です', 'error');
                        }
                    };
                    reader.readAsText(file);
                }
            });
            input.click();
        });

        document.getElementById('clearHistoryBtn').addEventListener('click', () => {
            if (confirm('再生履歴を削除しますか？')) {
                document.dispatchEvent(new CustomEvent('harmonia:clearPlayHistory'));
                window.harmonia?.ui.showNotification('🗑️ 再生履歴をクリアしました', 'success');
            }
        });

        document.getElementById('resetSettingsBtn').addEventListener('click', () => {
            if (confirm('すべての設定をデフォルトにリセットしますか？')) {
                document.dispatchEvent(new CustomEvent('harmonia:resetSettings'));
                window.harmonia?.ui.showNotification('🔄 設定をリセットしました', 'success');
            }
        });

        document.getElementById('deleteAllBtn').addEventListener('click', () => {
            if (confirm('⚠️ すべてのデータを削除します。この操作は取り消せません。本当によろしいですか？')) {
                if (confirm('本当に削除しますか？')) {
                    document.dispatchEvent(new CustomEvent('harmonia:deleteAllData'));
                    window.harmonia?.ui.showNotification('🔴 すべてのデータを削除しました', 'success');
                }
            }
        });

        document.getElementById('exportSettingsBtn').addEventListener('click', () => {
            document.dispatchEvent(new CustomEvent('harmonia:exportPlaylists'));
            window.harmonia?.ui.showNotification('📊 設定をエクスポートしています...', 'info');
        });

        // 再生速度ボタン
        document.querySelectorAll('#playback-panel .btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const speed = btn.textContent.replace('x', '');
                document.getElementById('playbackRateSlider').value = parseFloat(speed);
                document.getElementById('playbackRateSlider').dispatchEvent(new Event('input'));
            });
        });

        // プレイリスト管理モーダル
        document.getElementById('cancelPlaylistBtn').addEventListener('click', () => {
            window.harmonia.ui.closeModal('playlistManagementModal');
        });
        document.getElementById('createPlaylistSubmitBtn').addEventListener('click', async () => {
            const name = document.getElementById('playlistNameInput').value.trim();
            const description = document.getElementById('playlistDescInput').value.trim();
            const color = document.getElementById('playlistColorInput').value;

            if (!name) {
                window.harmonia.ui.showNotification('プレイリスト名を入力してください', 'warning');
                return;
            }

            try {
                const playlist = await window.harmonia.playlistManager.createPlaylist(name, description, { color });
                window.harmonia.ui.showNotification(`✅ プレイリスト「${name}」を作成しました`, 'success');
                window.harmonia.ui.closeModal('playlistManagementModal');
                
                // フォームリセット
                document.getElementById('playlistNameInput').value = '';
                document.getElementById('playlistDescInput').value = '';
                document.getElementById('playlistColorInput').value = '#6366f1';
                
                // プレイリストビューを更新
                window.harmonia.renderPlaylists?.();
            } catch (error) {
                console.error('❌ プレイリスト作成失敗:', error);
                window.harmonia.ui.showNotification('プレイリスト作成に失敗しました', 'error');
            }
        });

        document.getElementById('closePlaylistActionsModal').addEventListener('click', () => {
            window.harmonia.ui.closeModal('playlistActionsModal');
        });

        document.getElementById('editPlaylistBtn').addEventListener('click', () => {
            window.harmonia.ui.showNotification('プレイリスト編集機能は近日実装予定です', 'info');
        });

        document.getElementById('duplicatePlaylistBtn').addEventListener('click', async () => {
            const playlistId = window.harmonia._currentPlaylistId;
            if (!playlistId) return;

            try {
                await window.harmonia.playlistManager.duplicatePlaylist(playlistId);
                window.harmonia.ui.showNotification('✅ プレイリストを複製しました', 'success');
                window.harmonia.ui.closeModal('playlistActionsModal');
                window.harmonia.renderPlaylists?.();
            } catch (error) {
                console.error('❌ 複製失敗:', error);
                window.harmonia.ui.showNotification('複製に失敗しました', 'error');
            }
        });

        document.getElementById('exportPlaylistBtn').addEventListener('click', async () => {
            const playlistId = window.harmonia._currentPlaylistId;
            if (!playlistId) return;

            try {
                const json = await window.harmonia.playlistManager.exportPlaylist(playlistId, 'json');
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `playlist-${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
                window.harmonia.ui.showNotification('✅ プレイリストをエクスポートしました', 'success');
                window.harmonia.ui.closeModal('playlistActionsModal');
            } catch (error) {
                console.error('❌ エクスポート失敗:', error);
                window.harmonia.ui.showNotification('エクスポートに失敗しました', 'error');
            }
        });

        // プレイリスト共有
        const sharePlaylistBtn = document.getElementById('sharePlaylistBtn');
        if (sharePlaylistBtn) {
            sharePlaylistBtn.addEventListener('click', async () => {
                const playlistId = window.harmonia._currentPlaylistId;
                if (!playlistId) return;
                try {
                    if (window.harmonia && typeof window.harmonia.sharePlaylist === 'function') {
                        await window.harmonia.sharePlaylist(playlistId);
                    }
                    window.harmonia.ui.closeModal('playlistActionsModal');
                } catch (err) {
                    console.error('❌ 共有失敗:', err);
                    window.harmonia.ui.showNotification('共有に失敗しました', 'error');
                }
            });
        }

        document.getElementById('deletePlaylistBtn').addEventListener('click', async () => {
            const playlistId = window.harmonia._currentPlaylistId;
            if (!playlistId) return;

            if (confirm('このプレイリストを削除してもよろしいですか？')) {
                try {
                    await window.harmonia.playlistManager.deletePlaylist(playlistId);
                    window.harmonia.ui.showNotification('✅ プレイリストを削除しました', 'success');
                    window.harmonia.ui.closeModal('playlistActionsModal');
                    window.harmonia.renderPlaylists?.();
                } catch (error) {
                    console.error('❌ 削除失敗:', error);
                    window.harmonia.ui.showNotification('削除に失敗しました', 'error');
                }
            }
        });

        // ファイルアップロード
        document.getElementById('fileInput').addEventListener('change', (e) => {
            window.harmonia.handleFileUpload(e.target.files);
            window.harmonia.ui.closeModal('uploadModal');
        });

        // プレイヤーコントロール
        document.getElementById('playBtn').addEventListener('click', () => {
            window.harmonia.togglePlay();
        });
        document.getElementById('prevBtn').addEventListener('click', () => {
            window.harmonia.previous();
        });
        document.getElementById('nextBtn').addEventListener('click', () => {
            window.harmonia.next();
        });
        document.getElementById('shuffleBtn').addEventListener('click', () => {
            const settings = window.harmonia.state.get('settings');
            window.harmonia.state.updateSettings({ isShuffle: !settings.isShuffle });
        });
        document.getElementById('repeatBtn').addEventListener('click', () => {
            const settings = window.harmonia.state.get('settings');
            const modes = ['none', 'all', 'one'];
            const currentIndex = modes.indexOf(settings.repeatMode);
            const newMode = modes[(currentIndex + 1) % modes.length];
            window.harmonia.state.updateSettings({ repeatMode: newMode });
        });
        // トラック共有ボタン
        const shareTrackBtn = document.getElementById('shareTrackBtn');
        if (shareTrackBtn) {
            shareTrackBtn.addEventListener('click', () => {
                if (window.harmonia && typeof window.harmonia.shareCurrentTrack === 'function') {
                    window.harmonia.shareCurrentTrack();
                }
            });
        }

        // 検索
        document.getElementById('searchInput').addEventListener('input', (e) => {
            window.harmonia.state.setState({ searchQuery: e.target.value });
        });

        // キューをクリア
        document.getElementById('clearQueueBtn').addEventListener('click', () => {
            window.harmonia.state.clearQueue();
        });

        // ✨ 10バンドイコライザーはタブパネルで実装済み

        // テーマ切り替え
        document.querySelectorAll('.theme-option').forEach(option => {
            option.addEventListener('click', () => {
                const theme = option.dataset.theme;
                document.body.setAttribute('data-theme', theme);
                document.querySelectorAll('.theme-option').forEach(opt => {
                    opt.classList.remove('active');
                    opt.setAttribute('aria-checked', 'false');
                });
                option.classList.add('active');
                option.setAttribute('aria-checked', 'true');
                window.harmonia.state.updateSettings({ theme });
                // 永続化: 設定をDBに保存
                if (window.harmonia && typeof window.harmonia.saveSettings === 'function') {
                    window.harmonia.saveSettings(window.harmonia.state.get('settings'))
                        .catch(err => console.warn('Failed to save settings:', err));
                }
            });
        });

        // 設定トグル
        document.getElementById('visualizerToggle').addEventListener('change', (e) => {
            window.harmonia.state.updateSettings({ visualizerEnabled: e.target.checked });
            if (!e.target.checked) {
                window.harmonia.stopVisualizer();
            }
        });
        document.getElementById('backgroundPlayToggle').addEventListener('change', (e) => {
            window.harmonia.state.updateSettings({ backgroundPlayEnabled: e.target.checked });
        });
        document.getElementById('crossfadeToggle').addEventListener('change', (e) => {
            window.harmonia.state.updateSettings({ crossfadeEnabled: e.target.checked });
        });
        document.getElementById('gaplessToggle').addEventListener('change', (e) => {
            window.harmonia.state.updateSettings({ gaplessEnabled: e.target.checked });
        });

        // 追加設定: 表示密度 / ミニプレイヤー位置 / アクセントカラー
        const compactDensityEl = document.getElementById('compactDensity');
        if (compactDensityEl) {
            compactDensityEl.addEventListener('change', (e) => {
                window.harmonia.state.updateSettings({ compactDensity: e.target.value });
                document.body.setAttribute('data-density', e.target.value);
                if (window.harmonia && typeof window.harmonia.saveSettings === 'function') window.harmonia.saveSettings(window.harmonia.state.get('settings'));
            });
        }

        const miniPlayerPositionEl = document.getElementById('miniPlayerPosition');
        if (miniPlayerPositionEl) {
            miniPlayerPositionEl.addEventListener('change', (e) => {
                window.harmonia.state.updateSettings({ miniPlayerPosition: e.target.value });
                if (window.harmonia && typeof window.harmonia.saveSettings === 'function') window.harmonia.saveSettings(window.harmonia.state.get('settings'));
            });
        }

        document.querySelectorAll('.theme-accent').forEach(btn => {
            btn.addEventListener('click', () => {
                const accent = btn.dataset.accent;
                window.harmonia.state.updateSettings({ themeAccent: accent });
                if (window.harmonia && typeof window.harmonia.saveSettings === 'function') window.harmonia.saveSettings(window.harmonia.state.get('settings'));
            });
        });

        const customAccentPicker = document.getElementById('customAccentPicker');
        if (customAccentPicker) {
            customAccentPicker.addEventListener('input', (e) => {
                window.harmonia.state.updateSettings({ themeAccent: e.target.value });
                if (window.harmonia && typeof window.harmonia.saveSettings === 'function') window.harmonia.saveSettings(window.harmonia.state.get('settings'));
            });
        }

        // イコライザー有効化トグル
        const eqEnabledToggle = document.getElementById('eqEnabledToggle');
        if (eqEnabledToggle) {
            eqEnabledToggle.addEventListener('change', (e) => {
                window.harmonia.state.updateSettings({ eqEnabled: e.target.checked });
                if (!e.target.checked) {
                    // オフならUIのスライダーを無効化（CSS 側で見た目を変える想定）
                }
                if (window.harmonia && typeof window.harmonia.saveSettings === 'function') window.harmonia.saveSettings(window.harmonia.state.get('settings'));
            });
        }

        // 🔋 省エネモード（新機能）
        document.getElementById('powerSaveToggle').addEventListener('change', (e) => {
            const enabled = e.target.checked;
            const profileGroup = document.getElementById('powerSaveProfileGroup');
            profileGroup.style.display = enabled ? 'block' : 'none';

            const profile = document.querySelector('input[name="powerSaveProfile"]:checked')?.value || 'balanced';
            window.harmonia.setPowerSaveMode(enabled, profile);
        });

        document.querySelectorAll('input[name="powerSaveProfile"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const enabled = document.getElementById('powerSaveToggle').checked;
                if (enabled) {
                    window.harmonia.setPowerSaveMode(true, e.target.value);
                }
            });
        });

        // 再生速度
        document.getElementById('playbackRateSlider').addEventListener('input', (e) => {
            const rate = parseFloat(e.target.value);
            window.harmonia.setPlaybackRate(rate);
            document.getElementById('playbackRateValue').textContent = rate.toFixed(2) + 'x';
        });

        // クロスフェード時間スライダー
        const crossfadeDurationEl = document.getElementById('crossfadeDuration');
        if (crossfadeDurationEl) {
            const crossfadeValueEl = document.getElementById('crossfadeDurationValue');
            crossfadeDurationEl.addEventListener('input', (e) => {
                const sec = parseInt(e.target.value, 10);
                if (crossfadeValueEl) crossfadeValueEl.textContent = sec + 's';
                window.harmonia.state.updateSettings({ crossfadeDuration: sec });
                if (window.harmonia && typeof window.harmonia.saveSettings === 'function') window.harmonia.saveSettings(window.harmonia.state.get('settings'));
            });
        }

        // ラウドネス正規化
        const loudnessNormalizationEl = document.getElementById('loudnessNormalizationToggle');
        if (loudnessNormalizationEl) {
            loudnessNormalizationEl.addEventListener('change', (e) => {
                window.harmonia.state.updateSettings({ loudnessNormalization: e.target.checked });
                if (window.harmonia && typeof window.harmonia.saveSettings === 'function') window.harmonia.saveSettings(window.harmonia.state.get('settings'));
            });
        }

        // 最大音量制限
        const maxVolumeLimitEl = document.getElementById('maxVolumeLimit');
        if (maxVolumeLimitEl) {
            const maxVolumeLimitValueEl = document.getElementById('maxVolumeLimitValue');
            maxVolumeLimitEl.addEventListener('input', (e) => {
                const v = parseFloat(e.target.value);
                if (maxVolumeLimitValueEl) maxVolumeLimitValueEl.textContent = Math.round(v * 100) + '%';
                window.harmonia.state.updateSettings({ maxVolumeLimit: v });
                const currentVolume = window.harmonia.state.get('settings').volume || 0.7;
                if (currentVolume > v) {
                    window.harmonia.setVolume(v);
                }
                if (window.harmonia && typeof window.harmonia.saveSettings === 'function') window.harmonia.saveSettings(window.harmonia.state.get('settings'));
            });
        }

        // スリープタイマー
        document.getElementById('sleep15').addEventListener('click', () => {
            window.harmonia.setSleepTimer(15);
        });
        document.getElementById('sleep30').addEventListener('click', () => {
            window.harmonia.setSleepTimer(30);
        });
        document.getElementById('sleep45').addEventListener('click', () => {
            window.harmonia.setSleepTimer(45);
        });
        document.getElementById('sleep60').addEventListener('click', () => {
            window.harmonia.setSleepTimer(60);
        });
        document.getElementById('sleepCancel').addEventListener('click', () => {
            window.harmonia.clearSleepTimer();
            window.harmonia.ui.showNotification('スリープタイマーをキャンセルしました', 'info');
        });

        // A-Bリピート
        document.getElementById('abRepeatBtn').addEventListener('click', () => {
            window.harmonia.setupABRepeat();
        });

        // スリープタイマーの残り時間表示を更新
        window.harmonia.state.subscribe('sleepTimerRemaining', (remaining) => {
            const statusEl = document.getElementById('sleepTimerStatus');
            if (remaining > 0) {
                const mins = Math.floor(remaining / 60);
                const secs = remaining % 60;
                statusEl.textContent = `残り時間: ${mins}分${secs}秒`;
                statusEl.style.color = '#10b981';
            } else {
                statusEl.textContent = '';
            }
        });

        // �️ トラック削除（新機能）
        window.addEventListener('harmonia:deleteTrack', (e) => {
            const trackId = e.detail;
            window.harmonia.deleteTrack(trackId);
        });

        // �🔴 バグ修正: イベントリスナーを一元管理するための登録
        window.htmlEventListeners = [];

        // イベントリスナーをクリーンアップするメソッド（app.destroy()から呼ばれる）
        window.cleanupHtmlEventListeners = function() {
            console.log('🧹 Cleaning up HTML event listeners...');
        };

        // キャンバスサイズ調整
        const canvas = document.getElementById('visualizerCanvas');
        const resizeCanvas = () => {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
        };
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        window.htmlEventListeners.push({ element: window, event: 'resize', handler: resizeCanvas });

        // Service Worker登録と初期化完了後のチェック
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('✅ Service Worker registered'))
                .catch(err => console.log('❌ Service Worker registration failed:', err));
        }

        // 設定UIを保存済み設定で初期化する（app が初期化されるまで待つ）
        (function applySavedSettingsUI(timeout = 5000) {
            const start = Date.now();

            const tryApply = () => {
                const appObj = window.harmonia;
                if (appObj && appObj.state && typeof appObj.state.get === 'function') {
                    const settings = appObj.state.get('settings') || {};

                    // テーマ
                    if (settings.theme) document.body.setAttribute('data-theme', settings.theme);
                    // density
                    if (settings.compactDensity) document.body.setAttribute('data-density', settings.compactDensity);
                    // mini player position
                    if (settings.miniPlayerPosition) document.body.setAttribute('data-mini-position', settings.miniPlayerPosition);
                    // visualizer quality
                    if (settings.visualizerQuality) document.body.setAttribute('data-visualizer-quality', settings.visualizerQuality);
                    // accent
                    if (settings.themeAccent) {
                        try { document.documentElement.style.setProperty('--theme-accent', settings.themeAccent); } catch (e) {}
                    }

                    // コントロールを更新
                    const setIf = (id, value) => { const el = document.getElementById(id); if (el) el.value = value; };
                    const checkIf = (id, bool) => { const el = document.getElementById(id); if (el) el.checked = !!bool; };

                    checkIf('visualizerToggle', settings.visualizerEnabled);
                    setIf('visualizerStyle', settings.visualizerStyle || 'bars');
                    setIf('compactDensity', settings.compactDensity || 'comfortable');
                    setIf('miniPlayerPosition', settings.miniPlayerPosition || 'bottom');
                    const customAccent = document.getElementById('customAccentPicker'); if (customAccent && settings.themeAccent) customAccent.value = settings.themeAccent;
                    checkIf('eqEnabledToggle', settings.eqEnabled);
                    setIf('crossfadeDuration', settings.crossfadeDuration || 3); const cfv = document.getElementById('crossfadeDurationValue'); if (cfv) cfv.textContent = (settings.crossfadeDuration || 3) + 's';
                    checkIf('loudnessNormalizationToggle', settings.loudnessNormalization);
                    setIf('maxVolumeLimit', settings.maxVolumeLimit || 1.0); const mvv = document.getElementById('maxVolumeLimitValue'); if (mvv) mvv.textContent = Math.round((settings.maxVolumeLimit || 1.0) * 100) + '%';

                    // 適用: 現在音量が最大制限を超えていたら調整
                    try {
                        const curVol = appObj.state.get('settings').volume || appObj.state.get('volume') || 0.7;
                        const maxV = settings.maxVolumeLimit || 1.0;
                        if (curVol > maxV && appObj.setVolume) appObj.setVolume(maxV);
                    } catch (e) {}

                    return; // 完了
                }

                if (Date.now() - start < timeout) {
                    requestAnimationFrame(tryApply);
                } else {
                    console.warn('applySavedSettingsUI: app not ready, skipped initialization');
                }
            };

            tryApply();
        })();
    </script>
</body>
</html>
